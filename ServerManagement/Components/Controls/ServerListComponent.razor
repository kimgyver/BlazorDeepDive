@inject IServerService ServerService
@inject NavigationManager NavigationManager

@if (isLoading)
{
  <div class="text-center my-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading server list...</p>
  </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
  <div class="alert alert-danger">@errorMessage</div>
}
else if (servers is not null && servers.Count > 0)
{
  <table class="table table-striped">
    <RepeaterComponent Items="servers">
      <Header>
        <thead>
          <tr>
            <th>Name</th>
            <th>City</th>
            <th>Status</th>
            <th>People Online</th>
            <th></th>
            <th></th>
          </tr>
        </thead>
      </Header>   
      <Row Context="server">
        <ServerComponent Server="server" ReturnUrl="@GetReturnUrl()"></ServerComponent>
      </Row>    
    </RepeaterComponent>
  </table>
}
else
{
  <p class="text-muted">No servers</p>
}

@code {
  [Parameter]
  public string? CityName { get; set; }

  [Parameter]
  public string? SearchFilter { get; set; } = "";

  private List<Server>? servers;
  private bool isLoading = false;
  private string? errorMessage;

  protected override async Task OnParametersSetAsync()
  {
    isLoading = true;
    StateHasChanged();
    
    await Task.Delay(200);
    
    try
    {
      if (string.IsNullOrWhiteSpace(this.SearchFilter))
        servers = ServerService.GetServersByCity(CityName ?? "Toronto");
      else
        servers = ServerService.SearchServers(this.SearchFilter);
    }
    catch (ArgumentException ex)
    {
      Console.WriteLine($"Service error: {ex.Message}");
      errorMessage = "Failed to load servers.";
    }
    
    isLoading = false;
    StateHasChanged();
  }

  private string GetReturnUrl()
  {
    var queryParams = new List<string>();
    if (!string.IsNullOrWhiteSpace(SearchFilter))
    {
      queryParams.Add($"search={Uri.EscapeDataString(SearchFilter)}");
    }
    else if (!string.IsNullOrWhiteSpace(CityName) && CityName != "Toronto")
    {
      queryParams.Add($"city={Uri.EscapeDataString(CityName)}");
    }

    var url = "/servers";
    if (queryParams.Any())
    {
      url += "?" + string.Join("&", queryParams);
    }
    return url;
  }
}