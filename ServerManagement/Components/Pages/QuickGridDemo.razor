@page "/quickgrid"
@using Microsoft.AspNetCore.Components.QuickGrid

@rendermode InteractiveServer

@inject NavigationManager NavigationManager
@inject IServerService ServerService
@inject ILogger<QuickGridDemo> Logger

<h3>QuickGrid Demo</h3>
<br />

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (servers != null)
{
    <QuickGrid Items="servers.AsQueryable()" Pagination="paginationState">
        <PropertyColumn Property="s => s.Name"></PropertyColumn>
        <PropertyColumn Property="s => s.City" Sortable="true"></PropertyColumn>
        <TemplateColumn Title="Status" Sortable="true" SortBy="GridSort<Server>.ByAscending(s => s.IsOnline)">            @if (context.IsOnline)
            {
                <div style="color:green">
                    Online
                </div>
            }
            else
            {
                <div style="color:red">
                    Offline
                </div>
            }
        </TemplateColumn>
        <TemplateColumn Title="People Online">
            @if (context.IsOnline)
            {
                Random random = new Random();
                int randomNumber = random.Next(0, 500);
                <text>@randomNumber</text>
            }
            else
            {
                <text>N/A</text>
            }
        </TemplateColumn>
        <TemplateColumn>
            @if (context.IsOnline)
            {
                <button type="button"
                        class="btn btn-outline-danger"
                        @onclick="@(()=> {context.IsOnline = false;})">
                    Turn Off
                </button>
            }
            else
            {
                <button type="button"
                        class="btn btn-outline-success"
                        @onclick="@(()=> {context.IsOnline = true;})">
                    Turn On
                </button>
            }
        </TemplateColumn>
        <TemplateColumn>
            <a href="/server/@context.ServerId?ReturnUrl=/quickgrid" class="btn btn-outline-primary">Edit</a>
        </TemplateColumn>
        <TemplateColumn>
            <ChildContent Context="server">
                <EditForm Model="server"
                          FormName="@($"form-Server-{server.ServerId}")"
                          OnValidSubmit="@(async () => { await DeleteServer(server.ServerId); })">
                    <button type="submit" class="btn btn-primary">Delete</button>
                </EditForm>
            </ChildContent>            
        </TemplateColumn>
    </QuickGrid>
    <Paginator State="paginationState"></Paginator>
}


@code {
    private List<Server>? servers;
    private string? errorMessage;

    private PaginationState paginationState = new PaginationState { ItemsPerPage = 5 };
    
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                servers = ServerService.GetServers();
                Logger.LogInformation("Loaded {ServerCount} servers for QuickGrid", servers.Count);
            }
            catch (ArgumentException ex)
            {
                Logger.LogError(ex, "Error loading servers for QuickGrid");
                errorMessage = "Failed to load servers.";
            }
            StateHasChanged();
        }
    }

    private async Task DeleteServer(int serverId)
    {
        if (serverId > 0)
        {
            try
            {
                ServerService.DeleteServer(serverId);
                Logger.LogInformation("Deleted server ID {ServerId}", serverId);
                NavigationManager.NavigateTo("/quickgrid", true);
            }
            catch (ArgumentException ex)
            {
                Logger.LogError(ex, "Error deleting server ID {ServerId}", serverId);
            }
            await Task.CompletedTask;
        }
    }
}