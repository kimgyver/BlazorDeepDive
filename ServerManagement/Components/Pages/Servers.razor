@page "/servers"
@page "/servers/back_from/{cityName}"

@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<h3>Servers</h3>
<br/>

<ServerStatisticsComponent Mode="Simple" />
<br/>

<CityListComponent @ref="cityListComponent" SelectCityCallBack="HandleCitySelection" selectedCity="@selectedCity" />
<br/>

<SearchBarComponent 
    @ref="searchBarComponent"
    SearchServerCallback="HandleSearchServer"
    style="position:relative; width: 500px;" />
<br />

<CascadingValue Name="SelectedCity" Value="@selectedCity">
  <ServerListComponent CityName="@selectedCity" SearchFilter="@this.searchFilter" />
</CascadingValue>

<p>
  <a href="/server" class="btn btn-primary">Add Server</a>
</p>

@code {
  [Parameter]
  public string? CityName { get; set; }

  [SupplyParameterFromQuery]
  public string? City { get; set; }

  [SupplyParameterFromQuery]
  public string? Search { get; set; }

  private string selectedCity = "Toronto";
  private string searchFilter = "";
  private CityListComponent? cityListComponent;
  private SearchBarComponent? searchBarComponent;

  private void HandleSearch()
  {
    @* this.servers = ServersEfCoreRepository.SearchServers(this.serverFilter); *@
    @* this.selectedCity = string.Empty; *@
  }

  private void HandleCitySelection(string city)
  {
    this.selectedCity = city;
    this.searchFilter = string.Empty;
    searchBarComponent?.ClearFilter();
    UpdateUrl();
  }

  private void HandleSearchServer(string searchFilter)
  {
    @* this.servers = ServersEfCoreRepository.SearchServers(searchFilter); *@
    this.searchFilter = searchFilter;
    this.cityListComponent?.ClearSelection();
    UpdateUrl();
  }

  private void UpdateUrl()
  {
    var queryParams = new List<string>();
    if (!string.IsNullOrEmpty(searchFilter))
    {
      queryParams.Add($"search={Uri.EscapeDataString(searchFilter)}");
    }
    else if (selectedCity != "Toronto")
    {
      queryParams.Add($"city={Uri.EscapeDataString(selectedCity)}");
    }

    var url = "/servers";
    if (queryParams.Any())
    {
      url += "?" + string.Join("&", queryParams);
    }
    NavigationManager.NavigateTo(url, replace: true);
  }

  protected override void OnParametersSet()
  {
    // 쿼리 파라미터에서 상태 복원
    if (!string.IsNullOrEmpty(Search))
    {
      searchFilter = Search;
      if (searchBarComponent != null)
      {
        searchBarComponent.SetFilter(Search);
      }
    }
    else if (!string.IsNullOrEmpty(City))
    {
      selectedCity = City;
      if (cityListComponent != null)
      {
        cityListComponent.SetSelectedCity(City);
      }
    }
    else if (!string.IsNullOrEmpty(CityName))
    {
      // back_from route에서 도시명 복원
      selectedCity = CityName;
      if (cityListComponent != null)
      {
        cityListComponent.SetSelectedCity(CityName);
      }
    }
  }
}