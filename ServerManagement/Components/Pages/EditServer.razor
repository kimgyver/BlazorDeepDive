@page "/servers/{id:int}"
@inject NavigationManager NavigationManager
@inject IServerService ServerService
@inject ILogger<EditServer> Logger
@inject IJSRuntime JSRuntime
@using System.Text.Json

<NavigationLock 
  OnBeforeInternalNavigation="OnBeforeInternalNavigation"
  ConfirmExternalNavigation="true" />

<h3>Edit Server</h3>
<br/>
<br/>

@if (!string.IsNullOrEmpty(errorMessage))
{
  <div class="alert alert-danger">@errorMessage</div>
}
else if (server is not null)
{
  <EditForm Model="server" FormName="formServer" OnValidSubmit="Submit">
    <DataAnnotationsValidator></DataAnnotationsValidator>
    <ValidationSummary></ValidationSummary>
    <InputNumber @bind-Value="server.ServerId" hidden />

    <FieldComponent Label="Name">
      <Control>
        <InputText @bind-Value="server.Name" class="form-control" />
      </Control>
      <ValidationControl>
        <ValidationMessage For="() => server.Name" />
      </ValidationControl>
    </FieldComponent>

    <FieldComponent Label="City">
      <Control>
        <InputText @bind-Value="server.City" class="form-control" />
      </Control>
      <ValidationControl>
        <ValidationMessage For="() => server.City" />
      </ValidationControl>
    </FieldComponent>

    <FieldComponent Label="Online2">
      <Control>
        <InputCheckbox @bind-Value="server.IsOnline" class="form-check-input" />
      </Control>
    </FieldComponent>

    <br/>
    <button class="btn btn-primary" type="submit">Update</button>
  </EditForm>
}
<br/>
<a href="/servers" class="btn btn-primary">Close</a>


@code {
  [Parameter]
  public int Id { get; set; }

  [SupplyParameterFromForm(FormName = "formServer")]
  private Server? server {get; set;}

  private string? errorMessage;

  protected override void OnParametersSet()
  {
    try
    {
      server ??= ServerService.GetServerById(this.Id);
    }
    catch (ArgumentException ex)
    {
      Logger.LogError(ex, "Error loading server with ID {ServerId}", this.Id);
      errorMessage = "Server not found";
    }
  }

  private void Submit()
  {
    var input = JsonSerializer.Serialize(server);
    Logger.LogDebug("Updating server data: {ServerData}", input);

    try
    {
      if (server is not null)
      {
        ServerService.UpdateServer(server.ServerId, server);
        Logger.LogInformation("Server ID {ServerId} updated successfully", server.ServerId);
      }
    }
    catch (ArgumentException ex)
    {
      Logger.LogError(ex, "Error updating server ID {ServerId}", server?.ServerId ?? 0);
      return;
    }

    NavigationManager.NavigateTo($"/servers/back_from/{this.server?.City}");
  }

  private async Task OnBeforeInternalNavigation(LocationChangingContext context)
  {
    var isConfirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to leave this page?");
    if (!isConfirmed)
    {
      context.PreventNavigation();
    }
  }
} 