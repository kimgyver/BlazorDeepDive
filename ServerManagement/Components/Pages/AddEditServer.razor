@page "/server/{id:int?}"
@inject NavigationManager NavigationManager
@inject IServerService ServerService
@inject ILogger<AddEditServer> Logger
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms

<NavigationLock OnBeforeInternalNavigation="ConfirmNavigation" />

<CustomDialog Show="@showDialog"
              Title="Warning"
              Message="You have unsaved changes. Are you sure you want to leave?"
              OnClose="OnDialogClose" />

@if (@Id.HasValue)
{
  <h3>Edit Server</h3>
}
else
{
  <h3>Add Server</h3>
}
<br/>
<br/>

@if (!string.IsNullOrEmpty(errorMessage))
{
  <div class="alert alert-danger">@errorMessage</div>
}
else if (server is not null)
{
  <EditForm EditContext="@editContext" FormName="formServer" OnValidSubmit="Submit">
    <DataAnnotationsValidator></DataAnnotationsValidator>
    <ValidationSummary></ValidationSummary>

    @if (server.ServerId > 0)
    {
      <InputNumber @bind-Value="server.ServerId" hidden />
    }

    <FieldComponent Label="Name">
      <Control>
        <InputText @bind-Value="server.Name" class="form-control" />
      </Control>
      <ValidationControl>
        <ValidationMessage For="() => server.Name" />
      </ValidationControl>
    </FieldComponent>

    <FieldComponent Label="City">
      <Control>
        <InputText @bind-Value="server.City" class="form-control" />
      </Control>
      <ValidationControl>
        <ValidationMessage For="() => server.City" />
      </ValidationControl>
    </FieldComponent>

    <FieldComponent Label="Online">
      <Control>
        <InputCheckbox @bind-Value="server.IsOnline" class="form-check-input" />
      </Control>
    </FieldComponent>

    <br/>
    @if (server.ServerId > 0)
    {
      <button class="btn btn-primary" type="submit">Update</button>
    }
    else
    {
      <button class="btn btn-primary" type="submit">Save</button>
    }
    &nbsp;
    <a href="@((string.IsNullOrEmpty(ReturnUrl) ? "/servers" : ReturnUrl))" class="btn btn-primary">Close</a>
  </EditForm>
}

@code {
  [Parameter]
  public int? Id { get; set; }

  [SupplyParameterFromQuery]
  public string? City { get; set; }

  [SupplyParameterFromQuery]
  public string? ReturnUrl { get; set; }

  private Server? server { get; set; }

  private EditContext? editContext;
  private bool hasUnsavedChanges = false;
  private string? errorMessage;

  protected override void OnParametersSet()
  {
    if (this.Id.HasValue)
    {
      try
      {
        server ??= ServerService.GetServerById(this.Id.Value);
      }
      catch (ArgumentException ex)
      {
        Logger.LogError(ex, "Error loading server with ID {ServerId}", this.Id);
        errorMessage = "Server not found.";
      }
    }
    else
    {
      // For add mode, create a new Server object with IsOnline = false as default
      server ??= new Server() { IsOnline = false };
    }

    if (server is not null && !string.IsNullOrEmpty(this.City))
    {
      server.City = this.City;
    }

    if (server is not null)
    {
      if (editContext == null || editContext.Model != server)
      {
        if (editContext != null)
        {
          editContext.OnFieldChanged -= HandleFieldChanged;
        }
        editContext = new EditContext(server);
        editContext.OnFieldChanged += HandleFieldChanged;
        hasUnsavedChanges = false;
      }
    }
  }

  private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
  {
    hasUnsavedChanges = true;
  }

  private async Task ConfirmNavigation(LocationChangingContext context)
  {
      if (hasUnsavedChanges)
      {
          context.PreventNavigation();
          showDialog = true;
          pendingUri = context.TargetLocation;
          navigationTcs = new TaskCompletionSource<bool>();
          StateHasChanged();
          var result = await navigationTcs.Task;
          Logger.LogInformation("Navigation dialog result: {Result}, target URI: {TargetUri}", result, pendingUri);
          if (result && pendingUri is not null)
          {
              NavigationManager.NavigateTo(pendingUri);
          }
      }
  }

  private async Task OnDialogClose(bool confirmed)
  {
    showDialog = false;
    if (navigationTcs != null && !navigationTcs.Task.IsCompleted)
    {
        navigationTcs.SetResult(confirmed);
    }
    await Task.CompletedTask;
  }

  private TaskCompletionSource<bool>? navigationTcs;
  private bool showDialog = false;
  private string? pendingUri;

  private async Task Submit()
  {
    var input = JsonSerializer.Serialize(server);
    Logger.LogDebug("Submitting server data: {ServerData}", input);

    try
    {
      if (server is not null)
      {
        if (this.Id.HasValue)
        {
          await ServerService.UpdateServer(server.ServerId, server);
          Logger.LogInformation("Server ID {ServerId} updated successfully", server.ServerId);
        }
        else
        {
          await ServerService.AddServer(server);
          Logger.LogInformation("New server created: {ServerName} in {CityName}", server.Name, server.City);
        }

        hasUnsavedChanges = false;
      }
    }
    catch (ArgumentException ex)
    {
      Logger.LogError(ex, "Error submitting server data");
      return;
    }

    var target = string.IsNullOrEmpty(ReturnUrl) ? "/servers" : ReturnUrl;
    NavigationManager.NavigateTo(target);
  }

  public void Dispose()
  {
    if (editContext != null)
    {
      editContext.OnFieldChanged -= HandleFieldChanged;
    }
  }
}